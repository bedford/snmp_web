<!DOCTYPE html>
<html lang="en">
<head>
    <title>协议及串口设置</title>
    <meta http-equiv="Content-Type" content-type="text/html"; charset="utf-8">
	<link rel="stylesheet" href="css/cssReset.css" type="text/css">
	<link rel="stylesheet" href="css/jquery-ui.min.css">
	<style>
		.uart_box {
			margin-top: 20px;
			width: 100%;
			height: 15%;
			margin-bottom: 40px;
		}

		.horizental_split {
			height: 2px;
			width: 95%;
			background: #e5e5e5;
			overflow: hidden;
			margin-top: 10px;
		}

		.uart_content_box {
			height: 40px;
			margin-top: 15px;
			margin-left: 30px;
		}

		.uart_content_box > label {
			width: 80px;
			height: 30px;
			margin-left: 5px;
			vertical-align: middle;
		}

		.uart_content_box > select {
			width: 150px;
			height: 30px;
			margin-left: 5px;
			margin-right: 10px;
		}

		.uart_content_box .mid_select {
			width: 80px;
			height: 30px;
			margin-left: 5px;
			margin-right: 10px;
		}

		.uart_content_box .short_select {
			width: 40px;
			height: 30px;
			margin-left: 5px;
			margin-right: 10px;
		}

		.uart_content_box > input[type="checkbox"] {
			width: 25px;
			height: 25px;
			vertical-align: middle;
			margin-left: 40px;
		}

		.confirm_btn {
				background-color: #117daf;
				color: #fff;
				width: 100px;
				height: 30px;
				font-size: 14px;
				font-weight:bold;
				border: none;
				margin-left:30px;
		}
	</style>
</head>
<body>
	<div class="uart_box">
		<span style="width:150px;font-size:16px;">RS232串口设置</span>
		<div class="horizental_split"></div>
		<div class="uart_content_box">
			<label>协议类型</label>
			<select id="rs232_protocol_select">
				<option value="0"></option>
			</select>
			<label>波特率</label>
            <select id="rs232_baudrate_select" class="mid_select">
				<option value="1">2400</option>
				<option value="2">4800</option>
				<option value="3">9600</option>
				<option value="4">19200</option>
				<option value="5">38400</option>
				<option value="6">57600</option>
				<option value="7">115200</option>
			</select>
			<label>数据位</label>
			<select id="rs232_databits" class="short_select">
				<option value="5">5</option>
				<option value="6">6</option>
				<option value="7">7</option>
				<option value="8">8</option>
			</select>
			<label>停止位</label>
			<select id="rs232_stopbits" class="short_select">
				<option value="1">1</option>
				<option value="2">2</option>
			</select>
			<label>校验方式</label>
			<select id="rs232_parity" class="short_select">
				<option value="0">无</option>
				<option value="1">奇</option>
				<option value="2">偶</option>
			</select>
			<input id="rs232_checkbox" type="checkbox"><label>是否启用</label>
		</div>
	</div>
		<div class="uart_box">
		<span style="width:150px;font-size:16px;">RS485串口设置</span>
		<div class="horizental_split"></div>
		<div class="uart_content_box">
			<label>协议类型</label>
			<select id="rs485_protocol_select">
				<option value="0"></option>
			</select>
			<label>波特率</label>
            <select id="rs485_baudrate_select" class="mid_select">
				<option value="1">2400</option>
				<option value="2">4800</option>
				<option value="3">9600</option>
				<option value="4">19200</option>
				<option value="5">38400</option>
				<option value="6">57600</option>
				<option value="7">115200</option>
			</select>
			<label>数据位</label>
			<select id="rs485_databits" class="short_select">
				<option value="5">5</option>
				<option value="6">6</option>
				<option value="7">7</option>
				<option value="8">8</option>
			</select>
			<label>停止位</label>
			<select id="rs485_stopbits" class="short_select">
				<option value="1">1</option>
				<option value="2">2</option>
			</select>
			<label>校验方式</label>
			<select id="rs485_parity" class="short_select">
				<option value="0">无</option>
				<option value="1">奇</option>
				<option value="2">偶</option>
			</select>
			<input id="rs485_checkbox" type="checkbox"><label>是否启用</label>
		</div>
	</div>
	<div>
    	<input type="button" class="confirm_btn" id="confirm_btn" value="应用" onclick="set_uart_param()">
	</div>

	<div class="jq-dialog" id="hint_dialog" title="提示信息">
		<label id="hint_detail"></label>
	</div>

	<script src="js/jquery-1.12.0.js"></script>
	<script src="js/jquery-ui.min.js"></script>
	<script src="js/jquery.json-2.3.min.js"></script>
	<script>
        if (window.sessionStorage.getItem("user_information") == ""
            || window.sessionStorage.getItem("user_information") == null) {
            window.location.href = "/index.html";
        }

		/* 串口及设置相关 */
		function display_uart_param(io_param) {
			for (var i in io_param.support_list) {
			    $('#rs232_protocol_select').append('<option value="'+ io_param.support_list[i].protocol_id
					+ '">' + io_param.support_list[i].protocol_desc + '</option>');
				$('#rs485_protocol_select').append('<option value="'+ io_param.support_list[i].protocol_id
					+ '">' + io_param.support_list[i].protocol_desc + '</option>');
			}

			$('#rs232_protocol_select').val(io_param.rs232_cfg.protocol_id);
			$('#rs232_baudrate_select').val(io_param.rs232_cfg.baud);
			$('#rs232_databits').val(io_param.rs232_cfg.data_bits);
			$('#rs232_stopbits').val(io_param.rs232_cfg.stops_bits);
			$('#rs232_parity').val(io_param.rs232_cfg.parity);

			$('#rs485_protocol_select').val(io_param.rs485_cfg.protocol_id);
			$('#rs485_baudrate_select').val(io_param.rs485_cfg.baud);
			$('#rs485_databits').val(io_param.rs485_cfg.data_bits);
			$('#rs485_stopbits').val(io_param.rs485_cfg.stops_bits);
			$('#rs485_parity').val(io_param.rs485_cfg.parity);

			if (io_param.rs232_cfg.enable == 1) {
				$('#rs232_checkbox').attr("checked", true);
			}

			if (io_param.rs485_cfg.enable == 1) {
				$('#rs485_checkbox').attr("checked", true);
			}
		}

		function load_uart_param() {
		    var json = new Object();
		    json.msg_type = "param_setting";
		    json.cmd_type = "get_uart_param";
		    var data = $.toJSON(json);
		    $.ajax({
		                url     : "/cgi-bin/common.cgi",
		                type    : "POST",
		                dataType: "json",
		                data    : data,
		                success : function(msg) {
		                    display_uart_param(msg);
		                },
		            });
		}

		function set_uart_param() {
			var json = new Object();
			json.msg_type = "param_setting";
			json.cmd_type = "set_uart_param";

			var rs232_cfg = new Object();
			rs232_cfg.protocol_id = $('#rs232_protocol_select').val();
			if (rs232_cfg.protocol_id == null) {
				rs232_cfg.protocol_id = '0';
			}
			rs232_cfg.baud = $('#rs232_baudrate_select').val();
			rs232_cfg.data_bits = $('#rs232_databits').val();
			rs232_cfg.stops_bits = $('#rs232_stopbits').val();
			rs232_cfg.parity = $('#rs232_parity').val();
			if ($('#rs232_checkbox').is(':checked')) {
				rs232_cfg.enable = '1';
			} else {
				rs232_cfg.enable = '0';
			}

			var rs485_cfg = new Object();
			rs485_cfg.protocol_id = $('#rs485_protocol_select').val();
			if (rs485_cfg.protocol_id == null) {
				rs485_cfg.protocol_id = '0';
			}
			rs485_cfg.baud = $('#rs485_baudrate_select').val();
			rs485_cfg.data_bits = $('#rs485_databits').val();
			rs485_cfg.stops_bits = $('#rs485_stopbits').val();
			rs485_cfg.parity = $('#rs485_parity').val();
			if ($('#rs485_checkbox').is(':checked')) {
				rs485_cfg.enable = '1';
			} else {
				rs485_cfg.enable = '0';
			}

			var cfg = new Object();
			cfg.rs232_cfg = rs232_cfg;
			cfg.rs485_cfg = rs485_cfg;

			json.cfg = cfg;
			$('#confirm_btn').attr("disabled", "disabled");
			var data = $.toJSON(json);
		    $.ajax({
		                url     : "/cgi-bin/common.cgi",
		                type    : "POST",
		                dataType: "json",
		                data    : data,
		                success : function(msg) {
		                    $('#confirm_btn').removeAttr("disabled");
							var html = '';
							if (msg.status == 1) {
								html = '设置成功';
							} else {
								html = '设置失败';
							}
							$('#hint_detail').html(html);
							$('#hint_dialog').dialog({
								resizable: false,
								height: 160,
								modal: true,
								buttons: {
									"确定": function() {
										$(this).dialog("close");
									}
								}
							});
		                },
						error : function(msg) {
		                    $('#confirm_btn').removeAttr("disabled");
							var html = '操作失败';
							$('#hint_detail').html(html);
							$('#hint_dialog').dialog({
								resizable: false,
								height: 160,
								modal: true,
								buttons: {
									"确定": function() {
										$(this).dialog("close");
									}
								}
							});
						},
					});
		}

	$(document).ready(function() {
		load_uart_param();
	});
    </script>
</body>
</html>
