<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>status monitor</title>
	<style>
	#table-box {
		width: 100%;
		height: 80%;
		position: relative;
		box-sizing: border-box;
		padding-bottom: 34px;
	}
	.table-title {
		height: 34px;
		line-height: 34px;
		background-color: #9dd7f2;
		font-size: 0;
	}
	.table-title li {
		display: inline-block;
		width: 20%;
		text-align: center;
		font-size: 14px;
	}
	.table-title li+li {
		display: inline-block;
		width: 25%;
		text-align: center;
	}
	.table-content {
		height: 100%;
		overflow-y: auto;
	}
	.table-content > table {
		table-layout: fixed;
		width: 100%;
		border-collapse: collapse;
	}
	.table-content tr {
		height: 34px;
		background-color: #e4eff5;
	}
	.table-content tr th {
		text-align: center;
		color: #335d70;
		background-color: #9dd7f2;
	}
	.table-content tr td {
		width: 20%;
		text-align: center;
		color: #393c3d;
	}
	.table-content tr td+td {
		width: 25%;
		text-align: center;
		color: #393c3d;
	}
	.table-content tr td a {
		margin: 20px;
	}
	.table-content .warning {
		background-color: #f01818;
	}
	.warning td {
		color: #fff!important;
	}

	.operation_box {
		height: 20%;
		box-sizing: border-box;
		padding-top: 0px;
		padding-bottom: 0px;
	}

	#sms_rule_box {
		width: 50%;
		height: 100%;
		float: left;
	}

	#sms_rule_set {
		margin-top: 34px;
		margin-left: 20px;
		font-size: 14px;
	}

	#add_user_box {
		width: 50%;
		height: 100%;
		display: block;
		float:right;
	}

	#add_btn {
		margin-top: 34px;
		margin-right: 20px;
		background-color: #117daf;
		color: #fff;
		width: 150px;
		height: 40px;
		font-size: 14px;
		font-weight:bold;
		border-radius:5px;
		border: none;
		letter-spacing: 5px;
		float: right;
	}

	#set_btn {
		background-color: #e0e0e0;
		color: #000000;
		width: 80px;
		height: 30px;
		font-size: 12px;
		font-weight:bold;
	}

	.jq-dialog form fieldset {
		padding: 0;
		border: 0;
		margin-top: 25px;
	}

	.jq-dialog form fieldset > label {
		display: block;
	}

	.jq-dialog form fieldset > input[type="text"] {
		margin-bottom: 12px;
		width: 95%;
		padding: .4em;
	}

	</style>
	<link rel="stylesheet" href="css/cssReset.css">
	<link rel="stylesheet" href="css/jquery-ui.min.css">
	<script src="js/jquery-1.12.0.js"></script>
	<script src="js/jquery-ui.min.js"></script>
	<script src="js/jquery.json-2.3.min.js"></script>
</head>
<body>
	<div class="operation_box">
		<div id="sms_rule_box">
			<div id="sms_rule_set">
			<span>告警短信发送次数</span>
			<select id="send_times" style="margin-left:5px; margin-right:5px; width:50px; height:25px;">
				<option value="1">1</option>
				<option value="2">2</option>
				<option value="3">3</option>
			</select>
			<span>发送时间间隔（分钟）</span>
			<select id="send_interval" style="margin-left:5px; margin-right:5px; width:50px; height:25px;">
				<option value="1">5</option>
				<option value="2">10</option>
				<option value="3">15</option>
				<option value="4">20</option>
				<option value="5">25</option>
				<option value="6">30</option>
			</select>
			<input type="button" id="set_btn" value="设置" onclick="set_sms_rule()">
			</div>
		</div>
		<div id="add_user_box">
			<input type="button" id="add_btn" value="新增" onclick="add_sms_contact()">
		</div>
	</div>
	<div id="table-box">
		<div class="table-content">
			<table id="phone_table">
				<tr id="head">
					<th>编号</th>
					<th>姓名</th>
					<th>手机号码</th>
					<th>操作</th>
				</tr>
			</table>
		</div>
	</div>

    <div class="jq-dialog" id="new_dialog" title="新增短信联系人">
		<form>
			<fieldset>
				<label for="name">名字</label>
				<input type="text" name="new_name" id="new_name">
				<label for="name">手机号码</label>
				<input type="text" name="new_phone" id="new_phone">
			</fieldset>
		</form>
	</div>

	<div class="jq-dialog" id="modify_dialog" title="编辑短信联系人">
		<form>
			<fieldset>
				<label for="name">名字</label>
				<input type="text" name="modify_name" id="modify_name" disabled="true">
				<label for="name">手机号码</label>
				<input type="text" name="modify_phone" id="modify_phone">
			</fieldset>
		</form>
	</div>

	<div class="jq-dialog" id="confirm_dialog" title="删除短信联系人">
		<label id="delete_detail"></label>
	</div>

	<script>
		function load_sms_rule() {
		    var json = new Object();
		    json.msg_type = "alarm_setting";
		    json.cmd_type = "get_sms_rule";
		    var data = $.toJSON(json);
		    $.ajax({
		                url     : "/cgi-bin/common.cgi",
		                type    : "POST",
		                dataType: "json",
		                data    : data,
		                success : function(msg) {
							$("#send_times").val(msg.send_times);
							$("#send_interval").val(msg.send_interval);
		                },
		            });
		}

		function set_sms_rule() {
			var json = new Object();
			json.msg_type = "alarm_setting";
			json.cmd_type = "set_sms_rule";

			var cfg = new Object();
			cfg.send_times = $("#send_times").val();
			cfg.send_interval = $("#send_interval").val();
			json.cfg = cfg;

			$('#set_btn').attr("disabled", "disabled");
			var data = $.toJSON(json);
		    $.ajax({
		                url     : "/cgi-bin/common.cgi",
		                type    : "POST",
		                dataType: "json",
		                data    : data,
		                success : function(msg) {
		                    $('#set_btn').removeAttr("disabled");
							if (msg.status == 1) {
								alert("设置成功");
							} else {
								alert("设置失败");
							}
		                },
					});
		}

		function show_phone_user_list(phone_user_list) {
			$('#phone_table tr:not(:first)').remove();
			if (phone_user_list.count > 0) {
				var html="";
				$.each(phone_user_list.phone_user, function(i, item) {
					html+='<tr><td>'+item.id+'</td><td>'+item.name+'</div></td><td>'+item.phone+'</td>';
					html+='<td><a href="javascript:edit_item('+i+')">编辑</a> <a href="javascript:delete_item('+i+')">删除</a></td></tr>';
				});
				$('#phone_table').append(html);
			}
		}

		function load_phone_user() {
		    var json = new Object();
		    json.msg_type = "alarm_setting";
		    json.cmd_type = "get_phone_user";
		    var data = $.toJSON(json);
		    $.ajax({
		                url     : "/cgi-bin/common.cgi",
		                type    : "POST",
		                dataType: "json",
		                data    : data,
		                success : function(msg) {
							show_phone_user_list(msg);
		                },
		            });
		}

        $(document).ready(function () {
			load_phone_user();
			load_sms_rule();
        })

		function delete_phone_user(index) {
		    var json = new Object();
		    json.msg_type = "alarm_setting";
		    json.cmd_type = "delete_phone_user";
			json.id = $('#phone_table').find('tr').eq(index + 1).find('td').eq(0).html();
			json.name = $('#modify_name').val();
			json.phone = $('#modify_phone').val();
		    var data = $.toJSON(json);
		    $.ajax({
		                url     : "/cgi-bin/common.cgi",
		                type    : "POST",
		                dataType: "json",
		                data    : data,
		                success : function() {
							var tr = $('#phone_table').find('tr').eq(index + 1);
							tr.remove();
		                },
		            });
		}

        function delete_item(index) {
			var name = $('#phone_table').find('tr').eq(index + 1).find('td').eq(1).html();
			var phone = $('#phone_table').find('tr').eq(index + 1).find('td').eq(2).html();
			var html = '确认要删除联系人：  '+name+'  吗？';
			$('#delete_detail').html(html);
			$('#confirm_dialog').dialog({
				resizable: false,
				height: 160,
				modal: true,
				buttons: {
					"确定": function() {
						delete_phone_user(index);
						$(this).dialog("close");
					},
					取消: function() {
						$(this).dialog("close");
					}
				}
			});
		}

		function edit_phone_user(index, valuestring) {
		    var json = new Object();
		    json.msg_type = "alarm_setting";
		    json.cmd_type = "modify_phone_user";
			json.id = $('#phone_table').find('tr').eq(index + 1).find('td').eq(0).html();
			json.name = $('#modify_name').val();
			json.phone = $('#modify_phone').val();
		    var data = $.toJSON(json);
		    $.ajax({
		                url     : "/cgi-bin/common.cgi",
		                type    : "POST",
		                dataType: "json",
		                data    : data,
		                success : function() {
							var td =  $('#phone_table').find('tr').eq(index + 1).find('td').eq(2);
							td.empty();
							td.html(valuestring);
		                },
		            });
		}

        function edit_item(index) {
			var name = $('#phone_table').find('tr').eq(index + 1).find('td').eq(1).html();
			var phone = $('#phone_table').find('tr').eq(index + 1).find('td').eq(2).html();
			$('#modify_name').val(name);
			$('#modify_phone').val(phone);
			$('#modify_dialog').dialog({
				width: 300,
				height: 300,
				modal: true,
				buttons: {
					"确定": function() {
						edit_phone_user(index, $('#modify_phone').val());
						$(this).dialog("close");
					},
					取消: function() {
						$(this).dialog("close");
					}
				}
			});
		}

		function add_phone_user() {
		    var json = new Object();
		    json.msg_type = "alarm_setting";
		    json.cmd_type = "add_phone_user";
			json.name = $('#new_name').val();
			json.phone = $('#new_phone').val();
		    var data = $.toJSON(json);
		    $.ajax({
		                url     : "/cgi-bin/common.cgi",
		                type    : "POST",
		                dataType: "json",
		                data    : data,
		                success : function(msg) {
							show_phone_user_list(msg);
		                },
		            });
		}

		function add_sms_contact() {
			$('#new_dialog').dialog({
				width: 300,
				height: 300,
				modal: true,
				buttons: {
					"确定": function() {
						add_phone_user();
						$(this).dialog("close");
					},
					取消: function() {
						$(this).dialog("close");
					}
				}
			});
		}
	</script>
</body>
</html>
