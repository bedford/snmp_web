<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>status monitor</title>
	<style>
	#table-box {
    width: 100%;
    height: 85%;
    position: relative;
    box-sizing: border-box;
    padding-bottom: 34px;
	}
	.table-title {
		height: 34px;
		line-height: 34px;
		background-color: #9dd7f2;
		font-size: 0;
	}
	.table-title li {
		display: inline-block;
		width: 20%;
		text-align: center;
		font-size: 14px;
	}
	.table-title li+li {
		display: inline-block;
		width: 25%;
		text-align: center;
	}
	.table-content {
		height: 100%;
		overflow-y: auto;
	}
	.table-content > table {
		table-layout: fixed;
		width: 100%;
		border-collapse: collapse;
	}
	.table-content tr {
		height: 34px;
		background-color: #e4eff5;
	}
	.table-content tr th {
		text-align: center;
		color: #335d70;
		background-color: #9dd7f2;
	}
	.table-content tr td {
		width: 20%;
		text-align: center;
		color: #393c3d;
	}
	.table-content tr td+td {
		width: 25%;
		text-align: center;
		color: #393c3d;
	}
	.table-content tr td a {
		margin: 20px;
	}
	.table-content .warning {
		background-color: #f01818;
	}
	.warning td {
		color: #fff!important;
	}

	.operation_box {
		height: 15%;
		box-sizing: border-box;
		padding-top: 0px;
		padding-bottom: 0px;
	}

	#start_time_box {
	    display: inline-block;
		width: 25%;
		height: 100%;
		position: relative;
		box-sizing: border-box;
		padding-top: 10px;
	}
	#start_time {
		width:170px;
	}

	#end_time_box {
	    display: inline-block;
		width: 25%;
		height: 100%;
		position: relative;
		box-sizing: border-box;
		padding-top: 10px;
	}

	#end_time {
		width:170px;
	}

	#add_user_box {
		width: 30%;
		height: 100%;
		position: relative;
		box-sizing: border-box;
		padding-top: 10px;
		padding-left:30px;
		display: inline-block;
	}

	#query_btn {
		background-color: #117daf;
		color: #fff;
		width: 100px;
		height: 40px;
		font-size: 14px;
		font-weight:bold;
		border-radius:5px;
		border: none;
	}

	.btn_enable {
		background-color: #117daf;
	}

	#export_btn {
		color: #fff;
		width: 100px;
		height: 40px;
		font-size: 14px;
		font-weight:bold;
		border-radius:5px;
		border: none;
		margin-left: 40px;
	}
	</style>
	<link rel="stylesheet" href="css/cssReset.css">
	<script src="js/jquery-1.12.0.js"></script>
	<script src="js/jquery.json-2.3.min.js"></script>
	<script src="js/export_excel.js"></script>
	<script src="js/query_history.js"></script>
	<script src="js/WdatePicker.js"></script>
</head>
<body onbeforeunload="clear_sms_record()">
	<div class="operation_box">
		<div id="start_time_box">
			<span>开始时间</span>
			<input class="Wdate" type="text" id="start_time" onclick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss'})">
		</div>
		<div id="end_time_box">
			<span>结束时间</span>
			<input class="Wdate" type="text" id="end_time" onclick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss'})">
		</div>
		<select id="device_name" name="device_name" style="width:150px">
		<option>全部</option>
		<option>设备1</option>
		<option>设备2</option>
		</select>
		<div id="add_user_box">
			<input type="button" id="query_btn" value="查询" onclick="sms_sent_query()">
			<input type="button" id="export_btn" value="导出数据" onclick="export_data()">
		</div>
	</div>
	<div id="table-box">
		<div class="table-content">
			<table id="sms_table">
				<tr id="head">
					<th>时间</th>
					<th>设备名称</th>
					<th>参数名称</th>
					<th>告警类型</th>
					<th>接收人</th>
					<th>状态</th>
					<th>短信内容</th>
				</tr>
			</table>
		</div>
	</div>

	<script>
		function traverse_sms_record(data_list) {
			$("#sms_table tr:gt(0)").remove();
			var html="";
			$.each(data_list, function(i, item) {
				html+="<tr>";
				html+="<td>"+item.send_time+"</td>";
				html+="<td>"+item.device_name+"</td>";
				html+="<td>"+item.param_name+"</td>";
				html+="<td>"+item.alarm_desc+"</td>";
				html+="<td>"+item.phone+"</td>";
				html+="<td>"+item.send_status+"</td>";
				html+="<td>"+item.sms_content+"</td>";
				html+="</tr>"
			});
			$("#sms_table").append(html);

			window.localStorage.removeItem("sms_record");
			window.localStorage.setItem("sms_record", JSON.stringify(data_list));
		}

		function clear_sms_record() {
			window.localStorage.removeItem("sms_record");
		}

		function export_data() {
			var collection = window.localStorage.getItem("sms_record");
			var data = JSON.parse(collection);
			var title = new Array("时间", "设备名称", "参数名称", "报警描述", "电话号码", "状态", "短信内容");
			JSONToExcelConvertor(data, "sms_record", title);
		}

		function sms_sent_query() {
			var json = new Object();
			json.msg_type = "query_data";
			json.cmd_type = "query_sms_record";
			var data = $.toJSON(json);
			$.ajax({
			            url     : "/cgi-bin/common.cgi",
			            type    : "POST",
			            dataType: "json",
			            data    : data,
			            success : function(msg) {
							traverse_sms_record(msg.sms_record);
							$('#export_btn').addClass('btn_enable');
			            },
			        });
		}

        $(document).ready(function () {
			load_timepicker_default();
        })
    </script>
</body>
</html>
